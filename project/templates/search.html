{% extends 'index.html' %}
{% block content %}
{% set start_idx = 0 %}
{% set end_idx = 0 %}
{% set total_documents = 0 %}
{% set total_pages = 0 %}


{% if documents|length > 0 %}
    {% set total_documents = documents|length %}
    {% if total_documents > 20 %}
        {% set total_pages = total_documents // 20 + 1 %}
    {% else %}
        {% set total_pages = 1 %}
    {% endif %}
    {% set start_idx = (page - 1) * 20 %}
    {% if start_idx > total_documents %}
        {% set start_idx = 0 %}
    {% endif %}
    {% if start_idx + 20 < total_documents %}
        {% set end_idx = start_idx + 20 %}
    {% else %}
        {% set end_idx = total_documents %}
    {% endif %}
    {% set documents_slice = documents[start_idx:end_idx] %}
{% endif %}


<div class="container">
    <div class="row" id="section-title">
        <div class="col-md-11">
            <p>Search results Â· all repositories</p>
        </div>
        <div class="col-md-1">
            <div id="back-link">
                <a id="icon-arrow-left" href="#" title="Back" onclick="window.history.back();">
                    <span class="element-invisible">Back</span>
                </a>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-3 filters rounded-start">
            {% if query %}
            <div class="row">
                <h5 style="color: #00A6D6">Query</h5>
                <ul class="ul-query">
                    <li class="li-query">
                        <a href="{{ url_for('index') }}" title="Remove {{ query }}">(-) {{ query }}</a>
                    </li>
                </ul>
            </div>
            {% endif %}
            <div class="row">
                <h5>Collection</h5>
            </div>
            <div class="row">
                <h5>Document Type</h5>
            </div>
            <div class="row">
                <h5>Subject</h5>
            </div>
            <div class="row">
                <h5>Author</h5>
            </div>
            <div class="row">
                <h5>Date</h5>
            </div>
        </div>
        <div class="col-md-9 documents rounded-end">
            {% with query=query, documents=documents, total_pages=total_pages, page=page %}
            {% include 'search_navigation.html' %}
            {% endwith %}

            <div class="row document-results">
                {% if documents %}
                {% with query=query, documents=documents_slice, total_pages=total_pages, page=page %}
                {% include 'search_document.html' %}
                {% endwith %}

                {% else %}
                <div class="col-md-12">
                    <h4>Enter a search query</h4>
                </div>
                {% endif %}
            </div>

            <!-- Pagination at end of documents if there is a long list -->
            {% if end_idx - start_idx >= 20 %}
            {% with query=query, documents=documents, total_pages=total_pages, page=page %}
            {% include 'search_navigation.html' %}
            {% endwith %}
            {% endif %}
        </div>
    </div>
</div>
<!-- Clear localStorage variables on a new search -->
{% if clear_local_storage %}
<script>
    localStorage.removeItem("selectedKeywords");
    localStorage.removeItem("colorMapping");
</script>
{% endif %}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        let selectedKeywords = new Set(JSON.parse(localStorage.getItem("selectedKeywords")) || []);
        let colorMapping = JSON.parse(localStorage.getItem("colorMapping")) || {};
        let colors = ['#999999', '#f781bf', '#a65628', '#ffff33', '#ff7f00', '#984ea3', '#4daf4a', '#377eb8', '#e41a1c'];
        let availableColors = colors.filter(color => !Object.values(colorMapping).includes(color));

        function updateCheckboxes(value, isChecked) {
            document.querySelectorAll(".keyword-checkbox").forEach(function (checkbox) {
                if (checkbox.value === value) {
                    checkbox.checked = isChecked;
                }
            });
        }

        function storeSelectedKeywords() {
            localStorage.setItem("selectedKeywords", JSON.stringify(Array.from(selectedKeywords)));
        }

        // Restore the checked state of checkboxes from localStorage
        selectedKeywords.forEach(function (keyword) {
            updateCheckboxes(keyword, true);
        });

        document.querySelectorAll(".keyword-checkbox").forEach(function (checkbox) {
            checkbox.addEventListener("change", function () {
                const isChecked = checkbox.checked;

                if (isChecked) {
                    selectedKeywords.add(checkbox.value);
                } else {
                    selectedKeywords.delete(checkbox.value);
                    removeColor(checkbox.value);
                }

                if (selectedKeywords.size > 9) {
                    checkbox.checked = false;
                    selectedKeywords.delete(checkbox.value);
                    removeColor(checkbox.value);
                    isChecked = false;
                }

                updateCheckboxes(checkbox.value, isChecked);
                storeSelectedKeywords();

                // Update checkbox colors
                updateCheckboxColors();

                // Reload the page with the selected keywords as a query parameter
                const url = new URL(window.location.href);
                url.searchParams.set("selected_keywords", Array.from(selectedKeywords).join(','));
                window.location.href = url.toString();
            });
        });

        updateCheckboxes();

        function getColor(value) {
            if (!colorMapping[value]) {
                const color = availableColors.pop(); // Get the last available color
                colorMapping[value] = color;
                localStorage.setItem("colorMapping", JSON.stringify(colorMapping)); // Store colorMapping in localStorage
            }
            return colorMapping[value];
        }

        function removeColor(value) {
            if (colorMapping[value]) {
                availableColors.push(colorMapping[value]); // Add the removed color back to the availableColors stack
                delete colorMapping[value];
                localStorage.setItem("colorMapping", JSON.stringify(colorMapping)); // Update colorMapping in localStorage
            }
        }

        const checkboxes = document.querySelectorAll(".form-check-input");

        function updateCheckboxColors() {
            checkboxes.forEach(function (checkbox) {
                if (checkbox.checked) {
                    const color = getColor(checkbox.value);
                    checkbox.classList.add("custom-checkbox");
                    checkbox.style.backgroundColor = color;
                    checkbox.style.borderColor = color;
                } else {
                    checkbox.classList.remove("custom-checkbox");
                    checkbox.style.backgroundColor = "";
                    checkbox.style.borderColor = "";
                }
            });
        }

        updateCheckboxColors();
    });
</script>

{% endblock %}